<mxfile host="app.diagrams.net" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" version="24.7.14">
  <diagram name="Permata Gateway Flow" id="permata-gateway">
    <mxGraphModel dx="1422" dy="765" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="Permata Gateway - Webhook Processing Flow" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;fontColor=#1f497d;" vertex="1" parent="1">
          <mxGeometry x="320" y="20" width="480" height="30" as="geometry" />
        </mxCell>
        
        <!-- WhatsApp Business API -->
        <mxCell id="whatsapp" value="WhatsApp Business API" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d4e1f5;strokeColor=#6c8ebf;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="100" width="160" height="60" as="geometry" />
        </mxCell>
        
        <!-- Webhook Server -->
        <mxCell id="webhook-server" value="Webhook Server&#xa;(Hyper HTTP Server)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="100" width="160" height="60" as="geometry" />
        </mxCell>
        
        <!-- Request Validation -->
        <mxCell id="validation" value="Request Validation&#xa;&amp; Logging" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="300" y="200" width="120" height="80" as="geometry" />
        </mxCell>
        
        <!-- JSON Parsing -->
        <mxCell id="json-parse" value="Parse JSON Payload" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="210" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Payload Filter Decision -->
        <mxCell id="filter-decision" value="Is DR or&#xa;Inbound Flow?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="320" width="120" height="80" as="geometry" />
        </mxCell>
        
        <!-- DR Payload Check -->
        <mxCell id="dr-check" value="DR Payload Check:&#xa;• error field exists&#xa;• entry.changes.value.statuses" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="720" y="280" width="160" height="60" as="geometry" />
        </mxCell>
        
        <!-- Inbound Flow Check -->
        <mxCell id="inbound-check" value="Inbound Flow Check:&#xa;data.entry.changes.value&#xa;.messages.interactive&#xa;.type = 'nfm_reply'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="720" y="360" width="160" height="80" as="geometry" />
        </mxCell>
        
        <!-- Ignore Response -->
        <mxCell id="ignore-response" value="Return 200 OK&#xa;'Ignore send payload to client'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="300" y="450" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Token Manager -->
        <mxCell id="token-manager" value="Token Manager&#xa;(OAuth2)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="720" y="480" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Token Check -->
        <mxCell id="token-check" value="Valid Token?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="480" width="100" height="60" as="geometry" />
        </mxCell>
        
        <!-- Login to Permata -->
        <mxCell id="login-permata" value="Login to&#xa;Permata Bank API" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="720" y="580" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Generate Signature -->
        <mxCell id="generate-sig" value="Generate HMAC&#xa;Signature" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="580" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Send to Permata -->
        <mxCell id="send-permata" value="Send Webhook to&#xa;Permata Bank" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d4e1f5;strokeColor=#6c8ebf;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="320" y="580" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Retry Logic -->
        <mxCell id="retry-logic" value="Request Failed?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="320" y="680" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Retry Wait -->
        <mxCell id="retry-wait" value="Wait &amp; Retry&#xa;(Max 3 attempts)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="520" y="680" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Return Response -->
        <mxCell id="return-response" value="Return HTTP Response&#xa;to Client" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="120" y="680" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Token Scheduler -->
        <mxCell id="token-scheduler" value="Token Scheduler&#xa;(Background Process)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffd966;strokeColor=#d6b656;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="920" y="480" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Periodic Refresh -->
        <mxCell id="periodic-refresh" value="Periodic Token&#xa;Refresh (3 mins)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffd966;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="920" y="580" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Structured Logger -->
        <mxCell id="logger" value="Structured Logger&#xa;(JSON + File Rotation)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#666666;fontStyle=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="40" y="580" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Error Response -->
        <mxCell id="error-response" value="Error Response&#xa;(Auth Failed, etc)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="120" y="780" width="140" height="60" as="geometry" />
        </mxCell>
        
        <!-- Flow Arrows -->
        <!-- WhatsApp to Webhook Server -->
        <mxCell id="arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#1f497d;" edge="1" parent="1" source="whatsapp" target="webhook-server">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow1-label" value="HTTP POST /webhook" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#1f497d;" vertex="1" parent="1">
          <mxGeometry x="200" y="110" width="80" height="20" as="geometry" />
        </mxCell>
        
        <!-- Webhook Server to Validation -->
        <mxCell id="arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="webhook-server" target="validation">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Validation to JSON Parse (Valid) -->
        <mxCell id="arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="validation" target="json-parse">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow3-label" value="Valid" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="460" y="220" width="40" height="20" as="geometry" />
        </mxCell>
        
        <!-- JSON Parse to Filter Decision -->
        <mxCell id="arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="json-parse" target="filter-decision">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Filter Decision to DR Check -->
        <mxCell id="arrow5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="filter-decision" target="dr-check">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Filter Decision to Inbound Check -->
        <mxCell id="arrow6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="filter-decision" target="inbound-check">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Filter Decision to Ignore (No Match) -->
        <mxCell id="arrow7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d6b656;" edge="1" parent="1" source="filter-decision" target="ignore-response">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="360" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="arrow7-label" value="No Match" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="420" y="400" width="60" height="20" as="geometry" />
        </mxCell>
        
        <!-- DR/Inbound Check to Token Check -->
        <mxCell id="arrow8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="dr-check" target="token-check">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="720" y="320" as="sourcePoint" />
            <mxPoint x="620" y="480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="arrow8b" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="inbound-check" target="token-check">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="720" y="440" as="sourcePoint" />
            <mxPoint x="620" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="arrow8-label" value="Match" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="680" y="450" width="40" height="20" as="geometry" />
        </mxCell>
        
        <!-- Token Check to Token Manager (Invalid) -->
        <mxCell id="arrow9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="token-check" target="token-manager">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow9-label" value="Invalid/Expired" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="640" y="490" width="80" height="20" as="geometry" />
        </mxCell>
        
        <!-- Token Manager to Login -->
        <mxCell id="arrow10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="token-manager" target="login-permata">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Token Check to Generate Signature (Valid) -->
        <mxCell id="arrow11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="token-check" target="generate-sig">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow11-label" value="Valid" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="570" y="550" width="40" height="20" as="geometry" />
        </mxCell>
        
        <!-- Login to Generate Signature -->
        <mxCell id="arrow12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="login-permata" target="generate-sig">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="720" y="610" as="sourcePoint" />
            <mxPoint x="640" y="610" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Generate Signature to Send Permata -->
        <mxCell id="arrow13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="generate-sig" target="send-permata">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Send Permata to Retry Logic -->
        <mxCell id="arrow14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="send-permata" target="retry-logic">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Retry Logic to Retry Wait (Failed) -->
        <mxCell id="arrow15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="retry-logic" target="retry-wait">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow15-label" value="Failed &amp; Retries Left" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="430" y="690" width="100" height="20" as="geometry" />
        </mxCell>
        
        <!-- Retry Wait back to Send Permata -->
        <mxCell id="arrow16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="retry-wait" target="send-permata">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="580" y="680" as="sourcePoint" />
            <mxPoint x="440" y="640" as="targetPoint" />
            <Array as="points">
              <mxPoint x="580" y="660" />
              <mxPoint x="480" y="660" />
              <mxPoint x="480" y="610" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Retry Logic to Return Response (Success) -->
        <mxCell id="arrow17" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="retry-logic" target="return-response">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow17-label" value="Success" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="240" y="690" width="60" height="20" as="geometry" />
        </mxCell>
        
        <!-- Retry Logic to Error Response (All Retries Failed) -->
        <mxCell id="arrow18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#b85450;" edge="1" parent="1" source="retry-logic" target="error-response">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="380" y="740" as="sourcePoint" />
            <mxPoint x="190" y="780" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="arrow18-label" value="All Retries Failed" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="200" y="740" width="100" height="20" as="geometry" />
        </mxCell>
        
        <!-- Token Scheduler Flow -->
        <mxCell id="arrow19" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="token-scheduler" target="periodic-refresh">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Periodic Refresh to Token Manager -->
        <mxCell id="arrow20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="periodic-refresh" target="token-manager">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="920" y="610" as="sourcePoint" />
            <mxPoint x="840" y="520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Logger connections (dotted lines) -->
        <mxCell id="log1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=1;strokeColor=#666666;dashed=1;" edge="1" parent="1" source="logger" target="webhook-server">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="110" y="550" />
              <mxPoint x="110" y="130" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="log2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=1;strokeColor=#666666;dashed=1;" edge="1" parent="1" source="logger" target="send-permata">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="log3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=1;strokeColor=#666666;dashed=1;" edge="1" parent="1" source="logger" target="error-response">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-title" value="Legend:" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="920" y="100" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-solid" value="━━━ Main Flow" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;strokeColor=#1f497d;" vertex="1" parent="1">
          <mxGeometry x="920" y="130" width="100" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-dashed" value="┅┅┅ Background/Retry" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="920" y="150" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-dotted" value="⋯⋯⋯ Logging" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="920" y="170" width="80" height="20" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>